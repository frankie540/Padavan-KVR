name: Build-Padavan-deepseek2

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get -y install --no-install-recommends \
          unzip libtool-bin curl cmake gperf gawk flex bison \
          nano xxd fakeroot cpio git python3-docutils \
          gettext automake autopoint texinfo build-essential \
          help2man pkg-config zlib1g-dev libgmp3-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libltdl-dev wget \
          python2 python2-dev libc6-i386  # 关键：添加32位库

    - name: Set Python 2 as default
      run: |
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python2 1
        sudo update-alternatives --set python /usr/bin/python2

    - name: Clone source code
      env:
        KERNEL: 3.4
      run: |
        sudo rm -rf /opt/rt-n56u  # 确保目录干净
        sudo git clone --depth=1 https://github.com/frankie540/Padavan-KVR.git /opt/rt-n56u
        cd /opt/rt-n56u/toolchain-mipsel
        sh dl_toolchain.sh || { echo "❌ Toolchain download failed"; exit 1; }
        sudo ln -sf /opt/rt-n56u/toolchain-mipsel/toolchain-3.4.x /toolchain-3.4.x  # 路径修正
        sudo mkdir -p /opt/images/
        sudo chmod 777 /opt/images/

    - name: Build Firmware
      env:
        TNAME: K2P
        KERNEL: 3.4
      run: |
        export PATH="/opt/rt-n56u/toolchain-mipsel/toolchain-3.4.x/bin:$PATH"
        export CROSS_COMPILE="mipsel-linux-uclibc-"

        cd /opt/rt-n56u/trunk
        if [ ! -f "configs/templates/${TNAME}.config" ]; then
          echo "❌ Missing config file: ${TNAME}.config"
          exit 1
        fi
        cp -f "configs/templates/${TNAME}.config" .config

        fakeroot ./clear_tree || true
        fakeroot ./build_firmware_modify "${TNAME}" 0 || { echo "❌ Compilation failed"; exit 1; }
        sudo mv -f images/*.trx /opt/images/

    - name: Upload packages
      uses: actions/upload-artifact@v4
      with:
        name: Padavan-packages
        path: /opt/images/*.trx
